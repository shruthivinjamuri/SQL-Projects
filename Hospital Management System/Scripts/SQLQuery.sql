--2. Display the details of a patient named John Brown and also display the name of
---  doctor(s) who diagnosed him and also his total bill amount.

SELECT PT.PATIENT_ID, PT.SSN, PT.PATIENT_NAME, PT.PATIENT_ADDRESS,PT.DOB, PT.EMAIL, PT.PHONE_NUMBER, D.DOCTOR_NAME, D.DOCTOR_ID, SUM(BE.BILL_AMT) AS TOTAL_BILL_AMOUNT
FROM ADMISSION PT INNER JOIN PATIENT_ENCOUNTER PE ON (PT.PATIENT_ID = PE.PATIENT_ID)
INNER JOIN DOCTOR D ON (D.DOCTOR_ID = PE.DOCTOR_ID AND PE.ENCOUNTER_ID = D.ENCOUNTER_ID) 
INNER JOIN BILLING BE ON (BE.DOCTOR_ID = PE.DOCTOR_ID AND BE.ENCOUNTER_ID = PE.ENCOUNTER_ID AND PT.PATIENT_NAME = 'John Brown') 
GROUP BY PT.PATIENT_ID, PT.SSN, PT.PATIENT_NAME, PT.PATIENT_ADDRESS,PT.DOB, PT.EMAIL, PT.PHONE_NUMBER, D.DOCTOR_NAME,D.DOCTOR_ID

/*
Answer: 
1001	765878764	John Brown                    	786 Tryeb Ave, Apt #308, AP, HYD	1989-07-08	rreke@gmail.com	7362898172	KATE JACKIE	504	46.90
1001	765878764	John Brown                    	786 Tryeb Ave, Apt #308, AP, HYD	1989-07-08	rreke@gmail.com	7362898172	KATE SMITH	501	764.89
1001	765878764	John Brown                    	786 Tryeb Ave, Apt #308, AP, HYD	1989-07-08	rreke@gmail.com	7362898172	KITE SMALL	502	92.45
1001	765878764	John Brown                    	786 Tryeb Ave, Apt #308, AP, HYD	1989-07-08	rreke@gmail.com	7362898172	WANE JANE	503	43.80
1001	765878764	John Brown                    	786 Tryeb Ave, Apt #308, AP, HYD	1989-07-08	rreke@gmail.com	7362898172	WILSON JILL	505	123.80
*/

--3. Display the total number of patients diagnosed by Kate Smith on January 1st 2009.
SELECT COUNT(DISTINCT(PE.PATIENT_ID)) AS NO_OF_PATIENTS
FROM PATIENT_ENCOUNTER PE, DOCTOR DOC
WHERE PE.ENCOUNTER_ID = DOC.ENCOUNTER_ID AND DOC.DOCTOR_ID = PE.DOCTOR_ID AND
DOC.DOCTOR_NAME='KATE SMITH' AND PE.ENCOUNTER_DATE='1/1/2009'

--ans:2

--4.Display the year which has the maximum number of patients.
SELECT DATEPART(YYYY,PE.ENCOUNTER_DATE) AS [YEAR]
FROM PATIENT_ENCOUNTER PE
GROUP BY DATEPART(YYYY,PE.ENCOUNTER_DATE)
HAVING COUNT(DISTINCT(PE.PATIENT_ID)) >= ALL(SELECT COUNT(DISTINCT(PATIENT_ID))
											 FROM PATIENT_ENCOUNTER 
											 GROUP BY DATEPART(YYYY,ENCOUNTER_DATE)
											 )



--ans: 2010


--5.Display the details of a patient and the supervising doctor who was admitted more
--- than once during the year 2010.
SELECT PT.PATIENT_ID, PT.SSN, PT.PATIENT_NAME, PT.PATIENT_ADDRESS,PT.DOB, PT.EMAIL, PT.PHONE_NUMBER, D.DOCTOR_NAME, D.DOCTOR_ID
FROM ADMISSION PT INNER JOIN PATIENT_ENCOUNTER PE ON (PT.PATIENT_ID = PE.PATIENT_ID)
INNER JOIN DOCTOR D ON (D.DOCTOR_ID = PE.DOCTOR_ID)
WHERE DATEPART(YYYY,PE.ENCOUNTER_DATE) = '2010' 
AND PE.PATIENT_ID IN (SELECT PATIENT_ID 
				  FROM PATIENT_ENCOUNTER
				  GROUP BY PATIENT_ID,DATEPART(YYYY,ENCOUNTER_DATE)
				  HAVING COUNT(PATIENT_ID) > 1								
)
/*
Answer:
1001	765878764	John Brown                    	786 Tryeb Ave, Apt #308, AP, HYD	1989-07-08	rreke@gmail.com	7362898172	KITE SMALL	502
1001	765878764	John Brown                    	786 Tryeb Ave, Apt #308, AP, HYD	1989-07-08	rreke@gmail.com	7362898172	KITE SMALL	502
1001	765878764	John Brown                    	786 Tryeb Ave, Apt #308, AP, HYD	1989-07-08	rreke@gmail.com	7362898172	WANE JANE	503
1001	765878764	John Brown                    	786 Tryeb Ave, Apt #308, AP, HYD	1989-07-08	rreke@gmail.com	7362898172	WILSON JILL	505
1001	765878764	John Brown                    	786 Tryeb Ave, Apt #308, AP, HYD	1989-07-08	rreke@gmail.com	7362898172	WILSON JILL	505
*/

--6.Display details of the department/units the doctors of which have billed the maximum amounts.

SELECT DEPARTMENT_ID,DEPARTMENT_NAME FROM DEPARTMENT_HOSP 
WHERE DEPARTMENT_ID IN (SELECT PE.DEPARTMENT_ID FROM PATIENT_ENCOUNTER PE, BILLING BILL 
						WHERE PE.ENCOUNTER_ID = BILL.ENCOUNTER_ID AND PE.DOCTOR_ID = BILL.DOCTOR_ID
						GROUP BY PE.DEPARTMENT_ID HAVING SUM(BILL.BILL_AMT) 
						>= ALL(SELECT SUM(B.BILL_AMT) FROM PATIENT_ENCOUNTER PE1,BILLING B
						WHERE PE1.ENCOUNTER_ID = B.ENCOUNTER_ID AND PE1.DOCTOR_ID = B.DOCTOR_ID
						GROUP BY PE1.DEPARTMENT_ID)
						)


--ANS:D102 -- Gynecology

